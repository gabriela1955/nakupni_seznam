<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>N√°kupn√≠ seznam</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{--muted:#94a3b8;--text:#e5e7eb;--line:rgba(148,163,184,.22);--card:rgba(17,27,46,.78);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#060b16,#0b1220 35%);color:var(--text);}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);background:rgba(6,11,22,.72);border-bottom:1px solid var(--line);}
    .wrap{max-width:820px;margin:0 auto;padding:16px;}
    h1{font-size:20px;margin:0 0 6px 0;}
    .sub{color:var(--muted);font-size:13px;margin:0 0 12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button,select{font:inherit}
    .search{flex:1;min-width:220px;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(17,27,46,.9);color:var(--text);}
    .btn{padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(17,27,46,.9);color:var(--text);}
    .btn.primary{border-color:rgba(34,197,94,.45);}
    .btn.danger{border-color:rgba(239,68,68,.45);}
    .btn.ghost{background:transparent}
    .select{padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(17,27,46,.9);color:var(--text);}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:rgba(17,27,46,.7);color:var(--muted);font-size:12px;}
    .tabs{display:flex;gap:10px;margin-top:10px;}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(17,27,46,.6);color:var(--muted);cursor:pointer}
    .tab.on{color:var(--text);border-color:rgba(34,197,94,.35);background:rgba(17,27,46,.9)}
    .grid{display:grid;grid-template-columns:1.6fr 1fr;gap:12px;align-items:start}
    @media (max-width: 860px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .panel h2{margin:0;padding:12px 14px;font-size:15px;border-bottom:1px solid var(--line);}
    .panel .inner{padding:12px 14px;}
    .cards{display:flex;flex-direction:column;gap:12px;padding:12px 0 60px 0;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .card h3{margin:0;padding:12px 14px;font-size:15px;border-bottom:1px solid var(--line);}
    .list{list-style:none;margin:0;padding:0}
    .item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-top:1px solid var(--line);}
    .item:first-child{border-top:none}
    .chk{width:22px;height:22px;border-radius:6px;border:1px solid var(--line);display:grid;place-items:center;flex:0 0 auto;background:rgba(6,11,22,.35);}
    .chk.on{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.45);}
    .label{flex:1;line-height:1.2;}
    .label.done{text-decoration:line-through;color:rgba(229,231,235,.55);}
    .x{border:none;background:transparent;color:rgba(148,163,184,.8);font-size:18px;padding:0 6px;cursor:pointer}
    .footerbar{position:fixed;left:0;right:0;bottom:0;background:rgba(6,11,22,.72);backdrop-filter:blur(10px);border-top:1px solid var(--line);}
    .footerbar .wrap{display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .count{color:var(--muted);font-size:13px;}
    dialog{border:none;border-radius:16px;padding:0;background:rgba(17,27,46,.98);color:var(--text);width:min(560px,92vw);}
    dialog::backdrop{background:rgba(0,0,0,.55);}
    .dlg{padding:14px;}
    .dlg h3{margin:0 0 10px 0;font-size:15px;}
    .field{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:rgba(6,11,22,.35);color:var(--text);}
    .muted{color:var(--muted);}
    .recipe{padding:10px 0;border-top:1px solid var(--line);}
    .recipe:first-child{border-top:none}
    .recipe .rname{font-weight:600}
    .recipe .ing{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35}
    .tiny{font-size:12px;color:var(--muted);}

    /* Print */
    @media print{
      header,.footerbar,#plansPanel{display:none !important;}
      body{background:white;color:black}
      .wrap{max-width:none}
      .card,.panel{background:white;border:1px solid #ddd}
      .label.done{text-decoration:line-through;color:#666}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>N√°kupn√≠ seznam</h1>
      <p class="sub">V√≠ce seznam≈Ø (T√Ωden 1 / T√Ωden 2 / Vlastn√≠). Generov√°n√≠ seznamu z j√≠deln√≠ƒçku, sd√≠len√≠, tisk do PDF. Offline.</p>

      <div class="row">
        <label class="pill" for="listSel">üìã Seznam</label>
        <select id="listSel" class="select"></select>

        <input id="q" class="search" placeholder="Hledat (nap≈ô. ‚Äöokurka‚Äò, ‚Äöjogurt‚Äò)‚Ä¶" />
        <button class="btn primary" id="addBtn">+ P≈ôidat</button>
        <button class="btn" id="shareBtn">Sd√≠let</button>
        <button class="btn" id="printBtn">Tisk/PDF</button>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>

      <div style="margin-top:10px" class="row">
        <span class="pill">‚úÖ <span id="doneP">0</span></span>
        <span class="pill">üß∫ <span id="leftP">0</span></span>
        <span class="pill">üí° <span class="muted">Tip: ‚ÄûP≈ôidat na plochu‚Äú = aplikace</span></span>
      </div>

      <div class="tabs">
        <button class="tab on" id="tabList">Seznam</button>
        <button class="tab" id="tabPlan">J√≠deln√≠ƒçek</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="viewList">
      <div id="cards" class="cards"></div>
    </div>

    <div id="viewPlan" style="display:none">
      <div class="grid">
        <section class="panel" id="plansPanel">
          <h2>J√≠deln√≠ƒçek</h2>
          <div class="inner">
            <div class="row" style="margin-bottom:10px">
              <label class="pill" for="planSel">üóìÔ∏è Pl√°n</label>
              <select id="planSel" class="select" style="flex:1"></select>
            </div>
            <div class="row" style="margin-bottom:12px">
              <button class="btn primary" id="genBtn">Vytvo≈ôit n√°kupn√≠ seznam z tohoto j√≠deln√≠ƒçku</button>
              <button class="btn" id="appendBtn">P≈ôidat do aktu√°ln√≠ho seznamu</button>
            </div>
            <p class="tiny">‚ÄûVytvo≈ôit‚Äú p≈ôep√≠≈°e polo≈æky v aktu√°ln√≠m seznamu. ‚ÄûP≈ôidat‚Äú ponech√° existuj√≠c√≠ polo≈æky a dopln√≠ chybƒõj√≠c√≠.</p>
          </div>
        </section>

        <section class="panel">
          <h2>Recepty v pl√°nu</h2>
          <div class="inner" id="recipesBox"></div>
        </section>
      </div>
    </div>
  </main>

  <div class="footerbar">
    <div class="wrap">
      <div class="count" id="countLine"></div>
      <div style="display:flex; gap:10px">
        <button class="btn" id="hideDoneBtn">Skr√Ωt hotov√©</button>
        <button class="btn" id="markAllBtn">Oznaƒçit v≈°e</button>
        <button class="btn ghost" id="renameBtn">P≈ôejmenovat seznam</button>
      </div>
    </div>
  </div>

  <dialog id="dlg">
    <div class="dlg">
      <h3>P≈ôidat polo≈æku</h3>
      <p class="muted" style="margin:0 0 10px 0">Nap≈ô. ‚ÄûAvok√°do‚Äú, ‚ÄûPeƒçivo‚Äú, ‚ÄûKoriandr‚Äú‚Ä¶</p>
      <input id="newName" class="field" placeholder="N√°zev polo≈æky" />
      <div class="row" style="margin-top:10px">
        <select id="newCat" class="field" style="flex:1"></select>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:10px">
        <button class="btn" id="cancelBtn">Zru≈°it</button>
        <button class="btn primary" id="saveBtn">Ulo≈æit</button>
      </div>
    </div>
  </dialog>

  <script>
    const APP_DATA = {"plans": [{"id": "week1", "name": "T√Ωden 1 (z na≈°ich recept≈Ø)", "recipes": [{"name": "Ku≈ôec√≠ prsa + quinoa + peƒçen√° zelenina", "ingredients": [{"category": "Maso / ryby / b√≠lkoviny", "name": "Ku≈ôec√≠ prsa (cca 700 g)"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Quinoa ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Cuketa ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Paprika ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Mrkev ‚Äì 4 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "Losos + r√Ω≈æe + okurkov√Ω sal√°t", "ingredients": [{"category": "Maso / ryby / b√≠lkoviny", "name": "Losos ‚Äì 2 filety"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "R√Ω≈æe (basmati / natural) ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Sal√°tov√° okurka ‚Äì 3 ks"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "B√≠l√Ω jogurt / skyr ‚Äì 3 balen√≠"}, {"category": "Ovoce", "name": "Citr√≥ny ‚Äì 2 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Kopr (ƒçerstv√Ω/su≈°en√Ω)"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "ƒåoƒçkov√Ω sal√°t s fetou", "ingredients": [{"category": "Lu≈°tƒõniny / hotov√© produkty", "name": "ƒåoƒçka v konzervƒõ ‚Äì 1 ks"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "Feta / balk√°nsk√Ω s√Ωr ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Rajƒçata ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Paprika ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Jarn√≠ cibulka ‚Äì 1 svazek"}, {"category": "Ovoce", "name": "Citr√≥ny ‚Äì 2 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "Tortilla wrap (ku≈ôe / tu≈à√°k)", "ingredients": [{"category": "P≈ô√≠lohy / peƒçivo", "name": "Celozrnn√© tortilly ‚Äì 1 balen√≠"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Tu≈à√°k ve vlastn√≠ ≈°≈•√°vƒõ ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Listov√Ω sal√°t / rukola ‚Äì 2 balen√≠"}, {"category": "Zelenina", "name": "Rajƒçata ‚Äì 4 ks"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "B√≠l√Ω jogurt / skyr ‚Äì 3 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Ho≈ôƒçice"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "Zeleninov√° pol√©vka", "ingredients": [{"category": "Zelenina", "name": "Mrkev ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Cuketa ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Cibule / p√≥rek ‚Äì 1 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Celozrnn√Ω chl√©b / peƒçivo ‚Äì 1 balen√≠"}]}, {"name": "Sal√°t s vejcem / tu≈à√°kem", "ingredients": [{"category": "Maso / ryby / b√≠lkoviny", "name": "Vejce ‚Äì 10 ks"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Tu≈à√°k ve vlastn√≠ ≈°≈•√°vƒõ ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Listov√Ω sal√°t / rukola ‚Äì 2 balen√≠"}, {"category": "Zelenina", "name": "Rajƒçata ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Sal√°tov√° okurka ‚Äì 3 ks"}, {"category": "Ovoce", "name": "Citr√≥ny ‚Äì 2 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "Restovan√° zelenina + tofu/ku≈ôe", "ingredients": [{"category": "Zelenina", "name": "Mra≈æen√° zelenina ‚Äì 1 balen√≠"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Tofu ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S√≥jov√° om√°ƒçka"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}]}, {"name": "Cottage / tvaroh + zelenina + sem√≠nka", "ingredients": [{"category": "Ml√©ƒçn√© v√Ωrobky", "name": "Cottage s√Ωr ‚Äì 2 balen√≠"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "Tvaroh mƒõkk√Ω ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Paprika ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Sal√°tov√° okurka ‚Äì 3 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Sem√≠nka (sluneƒçnice / d√Ωnƒõ) ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "Zeleninov√° omeleta", "ingredients": [{"category": "Maso / ryby / b√≠lkoviny", "name": "Vejce ‚Äì 10 ks"}, {"category": "Zelenina", "name": "Cuketa ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Paprika ‚Äì 4 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}]}, {"name": "Sn√≠danƒõ/svaƒçiny (z√°klad)", "ingredients": [{"category": "Ml√©ƒçn√© v√Ωrobky", "name": "B√≠l√Ω jogurt / skyr ‚Äì 3 balen√≠"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Ovesn√© vloƒçky ‚Äì 1 balen√≠"}, {"category": "Ovoce", "name": "Jablka ‚Äì 4 ks"}, {"category": "Ovoce", "name": "Ban√°ny ‚Äì 4 ks"}, {"category": "Ovoce", "name": "Ovoce do jogurtu (bor≈Øvky / jahody) ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "O≈ôechy ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Ara≈°√≠dov√© m√°slo (100 %)"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Kn√§ckebrot ‚Äì 1 balen√≠"}, {"category": "Lu≈°tƒõniny / hotov√© produkty", "name": "Hummus ‚Äì 1 balen√≠"}, {"category": "Voliteln√©", "name": "Ho≈ôk√° ƒçokol√°da"}, {"category": "Voliteln√©", "name": "Proteinov√© tyƒçinky (2‚Äì3 ks)"}]}]}, {"id": "week2", "name": "T√Ωden 2 (≈°ablona ‚Äì uprav si)", "recipes": [{"name": "≈†ablona", "ingredients": [{"category": "Zelenina", "name": "(dopl≈à si polo≈æky)"}]}]}], "defaultLists": [{"id": "list-week1", "name": "T√Ωden 1", "planId": "week1", "items": [{"category": "Maso / ryby / b√≠lkoviny", "name": "Ku≈ôec√≠ prsa (cca 700 g)"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Quinoa ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Cuketa ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Paprika ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Mrkev ‚Äì 4 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Olivov√Ω olej"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S≈Øl, pep≈ô"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Losos ‚Äì 2 filety"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "R√Ω≈æe (basmati / natural) ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Sal√°tov√° okurka ‚Äì 3 ks"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "B√≠l√Ω jogurt / skyr ‚Äì 3 balen√≠"}, {"category": "Ovoce", "name": "Citr√≥ny ‚Äì 2 ks"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Kopr (ƒçerstv√Ω/su≈°en√Ω)"}, {"category": "Lu≈°tƒõniny / hotov√© produkty", "name": "ƒåoƒçka v konzervƒõ ‚Äì 1 ks"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "Feta / balk√°nsk√Ω s√Ωr ‚Äì 1 balen√≠"}, {"category": "Zelenina", "name": "Rajƒçata ‚Äì 4 ks"}, {"category": "Zelenina", "name": "Jarn√≠ cibulka ‚Äì 1 svazek"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Celozrnn√© tortilly ‚Äì 1 balen√≠"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Tu≈à√°k ve vlastn√≠ ≈°≈•√°vƒõ ‚Äì 2 ks"}, {"category": "Zelenina", "name": "Listov√Ω sal√°t / rukola ‚Äì 2 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Ho≈ôƒçice"}, {"category": "Zelenina", "name": "Cibule / p√≥rek ‚Äì 1 ks"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Celozrnn√Ω chl√©b / peƒçivo ‚Äì 1 balen√≠"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Vejce ‚Äì 10 ks"}, {"category": "Zelenina", "name": "Mra≈æen√° zelenina ‚Äì 1 balen√≠"}, {"category": "Maso / ryby / b√≠lkoviny", "name": "Tofu ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "S√≥jov√° om√°ƒçka"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "Cottage s√Ωr ‚Äì 2 balen√≠"}, {"category": "Ml√©ƒçn√© v√Ωrobky", "name": "Tvaroh mƒõkk√Ω ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Sem√≠nka (sluneƒçnice / d√Ωnƒõ) ‚Äì 1 balen√≠"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Ovesn√© vloƒçky ‚Äì 1 balen√≠"}, {"category": "Ovoce", "name": "Jablka ‚Äì 4 ks"}, {"category": "Ovoce", "name": "Ban√°ny ‚Äì 4 ks"}, {"category": "Ovoce", "name": "Ovoce do jogurtu (bor≈Øvky / jahody) ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "O≈ôechy ‚Äì 1 balen√≠"}, {"category": "O≈ôechy / sem√≠nka / dochucovadla", "name": "Ara≈°√≠dov√© m√°slo (100 %)"}, {"category": "P≈ô√≠lohy / peƒçivo", "name": "Kn√§ckebrot ‚Äì 1 balen√≠"}, {"category": "Lu≈°tƒõniny / hotov√© produkty", "name": "Hummus ‚Äì 1 balen√≠"}, {"category": "Voliteln√©", "name": "Ho≈ôk√° ƒçokol√°da"}, {"category": "Voliteln√©", "name": "Proteinov√© tyƒçinky (2‚Äì3 ks)"}]}, {"id": "list-week2", "name": "T√Ωden 2", "planId": "week2", "items": [{"category": "Zelenina", "name": "(dopl≈à si polo≈æky)"}]}, {"id": "list-custom", "name": "Vlastn√≠", "planId": null, "items": []}]};

    const STORAGE = {
      lists: "ns_lists_v2",
      current: "ns_current_list_v2",
      prefs: "ns_prefs_v2",
      itemsPrefix: "ns_items_v2__"
    };

    const state = {
      lists: [],
      currentListId: null,
      items: [],
      hideDone: false,
      view: "list",
      currentPlanId: APP_DATA.plans[0]?.id || null,
    };

    function uid() { return crypto.randomUUID(); }

    function normalizeKey(s){
      return (s||"").toLowerCase().replace(/\s+/g," ").trim();
    }

    function load(){
      // prefs
      const prefRaw = localStorage.getItem(STORAGE.prefs);
      if (prefRaw) { try { const p = JSON.parse(prefRaw); state.hideDone = !!p.hideDone; } catch {} }

      // lists
      const listsRaw = localStorage.getItem(STORAGE.lists);
      if (listsRaw){
        try { state.lists = JSON.parse(listsRaw); } catch { state.lists = structuredClone(APP_DATA.defaultLists); }
      } else {
        state.lists = structuredClone(APP_DATA.defaultLists);
      }

      // current list
      state.currentListId = localStorage.getItem(STORAGE.current) || state.lists[0]?.id || "list-week1";

      // plan
      const planSelRaw = localStorage.getItem("ns_plan_v2");
      if (planSelRaw) state.currentPlanId = planSelRaw;

      loadItemsForCurrent();
    }

    function persistLists(){
      localStorage.setItem(STORAGE.lists, JSON.stringify(state.lists));
      localStorage.setItem(STORAGE.current, state.currentListId);
      localStorage.setItem(STORAGE.prefs, JSON.stringify({hideDone: state.hideDone}));
      localStorage.setItem("ns_plan_v2", state.currentPlanId || "");
    }

    function itemsKey(listId){ return STORAGE.itemsPrefix + listId; }

    function loadItemsForCurrent(){
      const raw = localStorage.getItem(itemsKey(state.currentListId));
      if (raw){
        try { state.items = JSON.parse(raw); return; } catch {}
      }
      // initialize from default list items (if defined)
      const meta = state.lists.find(l=>l.id===state.currentListId);
      const defaults = meta?.items || [];
      state.items = defaults.map(x => ({...x, done:false, id: uid()}));
      persistItems();
    }

    function persistItems(){
      localStorage.setItem(itemsKey(state.currentListId), JSON.stringify(state.items));
      persistLists();
    }

    function groupByCategory(items){
      const map = new Map();
      for (const it of items){
        if (!map.has(it.category)) map.set(it.category, []);
        map.get(it.category).push(it);
      }
      return map;
    }

    function fillListSelect(){
      const sel = document.getElementById("listSel");
      sel.innerHTML = "";
      for (const l of state.lists){
        const opt = document.createElement("option");
        opt.value = l.id; opt.textContent = l.name;
        sel.appendChild(opt);
      }
      sel.value = state.currentListId;
      sel.onchange = () => {
        state.currentListId = sel.value;
        loadItemsForCurrent();
        renderAll();
      };
    }

    function fillPlanSelect(){
      const sel = document.getElementById("planSel");
      sel.innerHTML = "";
      for (const p of APP_DATA.plans){
        const opt = document.createElement("option");
        opt.value = p.id; opt.textContent = p.name;
        sel.appendChild(opt);
      }
      sel.value = state.currentPlanId;
      sel.onchange = () => {
        state.currentPlanId = sel.value;
        persistLists();
        renderPlan();
      };
    }

    function currentPlan(){
      return APP_DATA.plans.find(p=>p.id===state.currentPlanId) || APP_DATA.plans[0];
    }

    function planToShopping(plan){
      const seen = new Set();
      const out = [];
      for (const r of plan.recipes){
        for (const ing of r.ingredients){
          const k = normalizeKey(ing.category) + "||" + normalizeKey(ing.name);
          if (!seen.has(k)){
            seen.add(k);
            out.push({category: ing.category, name: ing.name});
          }
        }
      }
      return out;
    }

    function applyShoppingToList(mode){
      // mode: "replace" or "append"
      const plan = currentPlan();
      const shopping = planToShopping(plan);

      if (mode === "replace"){
        state.items = shopping.map(x => ({...x, done:false, id: uid()}));
      } else {
        const existing = new Set(state.items.map(it => normalizeKey(it.category)+"||"+normalizeKey(it.name)));
        for (const x of shopping){
          const k = normalizeKey(x.category)+"||"+normalizeKey(x.name);
          if (!existing.has(k)){
            state.items.unshift({ ...x, done:false, id: uid() });
            existing.add(k);
          }
        }
      }
      persistItems();
      // Switch to list view
      setView("list");
    }

    function render(){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      let filtered = state.items.filter(it => it.name.toLowerCase().includes(q) || it.category.toLowerCase().includes(q));
      if (state.hideDone) filtered = filtered.filter(it => !it.done);

      const cards = document.getElementById("cards");
      cards.innerHTML = "";

      const grouped = groupByCategory(filtered);
      const cats = [...grouped.keys()].sort((a,b)=>a.localeCompare(b,'cs'));

      for (const cat of cats){
        const card = document.createElement("section");
        card.className = "card";
        const h = document.createElement("h3");
        h.textContent = cat;
        card.appendChild(h);

        const ul = document.createElement("ul");
        ul.className = "list";

        for (const it of grouped.get(cat)){
          const li = document.createElement("li");
          li.className = "item";

          const chk = document.createElement("button");
          chk.className = "chk" + (it.done ? " on" : "");
          chk.innerHTML = it.done ? "‚úì" : "";
          chk.onclick = () => { it.done = !it.done; persistItems(); renderAll(); };

          const label = document.createElement("div");
          label.className = "label" + (it.done ? " done" : "");
          label.textContent = it.name;

          const del = document.createElement("button");
          del.className = "x";
          del.title = "Smazat polo≈æku";
          del.textContent = "√ó";
          del.onclick = () => { state.items = state.items.filter(x => x.id !== it.id); persistItems(); renderAll(); };

          li.appendChild(chk);
          li.appendChild(label);
          li.appendChild(del);
          ul.appendChild(li);
        }

        card.appendChild(ul);
        cards.appendChild(card);
      }

      const done = state.items.filter(x=>x.done).length;
      const left = state.items.length - done;
      document.getElementById("doneP").textContent = done;
      document.getElementById("leftP").textContent = left;
      document.getElementById("countLine").textContent = `Seznam: ${currentListName()} ‚Ä¢ Hotovo: ${done} ‚Ä¢ Zb√Ωv√°: ${left} ‚Ä¢ Celkem: ${state.items.length}`;
      document.getElementById("hideDoneBtn").textContent = state.hideDone ? "Zobrazit hotov√©" : "Skr√Ωt hotov√©";
    }

    function renderPlan(){
      const box = document.getElementById("recipesBox");
      box.innerHTML = "";
      const plan = currentPlan();
      for (const r of plan.recipes){
        const div = document.createElement("div");
        div.className = "recipe";
        const rn = document.createElement("div");
        rn.className = "rname";
        rn.textContent = r.name;
        const ing = document.createElement("div");
        ing.className = "ing";
        ing.textContent = r.ingredients.map(x=>`${x.category}: ${x.name}`).join(" ‚Ä¢ ");
        div.appendChild(rn);
        div.appendChild(ing);
        box.appendChild(div);
      }
    }

    function renderAll(){
      fillListSelect();
      fillPlanSelect();
      render();
      renderPlan();
    }

    function fillCategorySelect(){
      const sel = document.getElementById("newCat");
      const cats = [...new Set(state.items.map(x=>x.category))].sort((a,b)=>a.localeCompare(b,'cs'));
      sel.innerHTML = "";
      for (const c of cats){
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        sel.appendChild(opt);
      }
      const optNew = document.createElement("option");
      optNew.value="__new__"; optNew.textContent="‚ûï Nov√° kategorie‚Ä¶";
      sel.appendChild(optNew);

      if (cats.length) sel.value = cats[0];

      sel.onchange = () => {
        if (sel.value === "__new__"){
          const newCat = prompt("N√°zev nov√© kategorie:");
          if (newCat && newCat.trim()){
            const real = newCat.trim();
            const opt = document.createElement("option");
            opt.value = real; opt.textContent = real;
            sel.insertBefore(opt, sel.lastElementChild);
            sel.value = real;
          } else {
            sel.value = cats[0] || "Ostatn√≠";
          }
        }
      };
    }

    function openAddDialog(){
      fillCategorySelect();
      document.getElementById("newName").value = "";
      document.getElementById("dlg").showModal();
      setTimeout(()=>document.getElementById("newName").focus(), 50);
    }

    function addItem(){
      const name = (document.getElementById("newName").value || "").trim();
      const cat = document.getElementById("newCat").value || "Ostatn√≠";
      if (!name) return;
      state.items.unshift({ id: uid(), name, category: cat, done:false });
      persistItems();
      document.getElementById("dlg").close();
      renderAll();
    }

    async function shareList(){
      const lines = [];
      const grouped = groupByCategory(state.items.filter(x=>!x.done));
      const cats = [...grouped.keys()].sort((a,b)=>a.localeCompare(b,'cs'));
      for (const c of cats){
        lines.push(c + ":");
        for (const it of grouped.get(c)) lines.push(" - " + it.name);
        lines.push("");
      }
      const text = lines.join("\n").trim();
      if (navigator.share){
        try { await navigator.share({ title: "N√°kupn√≠ seznam", text }); return; } catch(e){}
      }
      try { await navigator.clipboard.writeText(text); alert("Zkop√≠rov√°no do schr√°nky ‚úÖ"); }
      catch { prompt("Zkop√≠ruj seznam:", text); }
    }

    function resetAll(){
      if (!confirm("Opravdu resetovat aktu√°ln√≠ seznam na v√Ωchoz√≠ polo≈æky?")) return;
      const meta = state.lists.find(l=>l.id===state.currentListId);
      const defaults = meta?.items || [];
      state.items = defaults.map(x => ({...x, done:false, id: uid()}));
      persistItems();
      renderAll();
    }

    function markAll(){
      const allDone = state.items.every(x=>x.done);
      for (const it of state.items) it.done = !allDone;
      persistItems();
      renderAll();
    }

    function setView(v){
      state.view = v;
      document.getElementById("viewList").style.display = (v==="list") ? "" : "none";
      document.getElementById("viewPlan").style.display = (v==="plan") ? "" : "none";
      document.getElementById("tabList").classList.toggle("on", v==="list");
      document.getElementById("tabPlan").classList.toggle("on", v==="plan");
      if (v==="plan") renderPlan();
      if (v==="list") render();
    }

    function currentListName(){
      return state.lists.find(l=>l.id===state.currentListId)?.name || "Seznam";
    }

    function renameList(){
      const meta = state.lists.find(l=>l.id===state.currentListId);
      if (!meta) return;
      const n = prompt("Nov√Ω n√°zev seznamu:", meta.name);
      if (!n || !n.trim()) return;
      meta.name = n.trim();
      persistLists();
      renderAll();
    }

    // Events
    document.getElementById("q").addEventListener("input", render);
    document.getElementById("addBtn").addEventListener("click", openAddDialog);
    document.getElementById("shareBtn").addEventListener("click", shareList);
    document.getElementById("printBtn").addEventListener("click", () => window.print());
    document.getElementById("resetBtn").addEventListener("click", resetAll);
    document.getElementById("hideDoneBtn").addEventListener("click", () => { state.hideDone = !state.hideDone; persistLists(); renderAll(); });
    document.getElementById("markAllBtn").addEventListener("click", markAll);
    document.getElementById("renameBtn").addEventListener("click", renameList);

    document.getElementById("cancelBtn").addEventListener("click", () => document.getElementById("dlg").close());
    document.getElementById("saveBtn").addEventListener("click", addItem);
    document.getElementById("newName").addEventListener("keydown", (e)=>{ if (e.key==="Enter") addItem(); });

    document.getElementById("tabList").addEventListener("click", ()=>setView("list"));
    document.getElementById("tabPlan").addEventListener("click", ()=>setView("plan"));

    document.getElementById("genBtn").addEventListener("click", () => {
      if (!confirm("P≈ôepsat polo≈æky v aktu√°ln√≠m seznamu podle j√≠deln√≠ƒçku?")) return;
      applyShoppingToList("replace");
      renderAll();
    });
    document.getElementById("appendBtn").addEventListener("click", () => {
      applyShoppingToList("append");
      renderAll();
    });

    if ("serviceWorker" in navigator){
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
    }

    // Init
    load();
    renderAll();
  </script>
</body>
</html>
